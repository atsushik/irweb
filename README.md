# irweb
irkitもどきを安く作るための何か

## 目的

家電を多少なりとも制御しようと思うと、既存の家電を操作するための手段が極めて限られている現実に直面する。

エアコンやテレビ、電灯などは赤外線を用いたリモコンによる操作が可能だが、WEB API的に操作できるとさらに捗りそうな気がする。

用途は例えばカキなど。

- 寒い冬の明け方にベッドの中から他の部屋にあるエアコンの暖房をONにしたい
- 暑い夏の日に外から帰る前に室内を適温に冷やしておきたい
- 人感センサなどと組み合わせて電灯をON/OFFしたい

なお、学習リモコンは「送信できる信号は、過去に受信して記憶させたもののみ」という面で機能的に不足していると思っている。

このため、「室温が１８度になったら記憶させた温度で暖房をつける」はできるが、それ以上の細かい制御は（不可能ではないが）面倒くさいのでやらなくなる(が、多分、実用性という点ではそれで十分なのだとも思う)。

どうせなら任意の信号を出せる方が面白いと思うので簡単な変換スクリプトも作った。

## 材料
- [ESP8266なWIFIモジュール](http://akizukidenshi.com/catalog/g/gK-09758/) とARDUINOとして使うための一式
- [５ｍｍ赤外線ＬＥＤ　ＯＳＩ５ＬＡ５１１３Ａ　（１０個入）](http://akizukidenshi.com/catalog/g/gI-04311/)
- [赤外線リモコン受信モジュール　ＧＰ１ＵＸＣ４１ＱＳ](http://akizukidenshi.com/catalog/g/gI-06487/)
- [角型２色ＬＥＤ　赤・黄緑　ＧＬ８ＥＤ４８　（１０個)](http://akizukidenshi.com/catalog/g/gI-03255/)

## 配線
NODEMCUの絵を使っているけど、WROOMに適宜読み替える
![配線図](https://raw.githubusercontent.com/atsushik/irweb/master/irweb.png)

## 依存しているライブラリ
- [tzapu/WiFiManager](https://github.com/tzapu/WiFiManager)
- [markszabo/IRremoteESP8266](https://github.com/markszabo/IRremoteESP8266)
- [bblanchon/ArduinoJson](https://github.com/bblanchon/ArduinoJson)

## 使い方

### 初回起動時
「irweb_c1a1」みたいなWIFI-APが出現するので、そこにつなぐ。
少し待つと「Configure WiFi」と書かれたボタンが出るので、クリックして、表示されるAP一覧から接続したいのを選びパスワードを入力する。
次回起動時からはその情報を使ってWIFIに接続するようになる。
AP情報を消すにはWIFIモジュールの起動時に GPIO 5 をGNDに繋いでおくと、保存していた情報を消す。

### esp8266の探し方
osxならdns-sd コマンドで _irweb._tcp を探すとホスト名がわかる。
「irweb_」+「MACアドレスの下４文字」になっている
``` sh:find_irweb.sh
$ dns-sd -B _irweb._tcp
Browsing for _irweb._tcp
DATE: ---Sun 31 Jan 2016---
 2:21:45.561  ...STARTING...
Timestamp     A/R    Flags  if Domain               Service Type         Instance Name
 2:21:46.040  Add        2   5 local.               _irweb._tcp.         irweb_c1a1
```

linuxならavahi-browse コマンドで _irweb._tcp を探すとホスト名がわかる。
「irweb_」+「MACアドレスの下４文字」になっている
``` sh:find_irweb.sh
$ avahi-browse _irweb._tcp
+   eth0 IPv4 irweb_c1a1                                    _irweb._tcp          local
```

### 受信
受信したリモコンの信号は下記のURLにアクセスするとjson形式で取得できる

http://irweb_c1a1.local/messages
``` json:aquos_power.json
{"format":"raw","freq":38,"len":99,"data":[3400,1700,450,450,450,1250,450,450,450,1250,450,450,450,1250,450,450,450,1250,450,450,450,1250,450,450,450,1250,450,1250,450,450,450,1250,450,450,450,1250,450,1250,450,1250,450,1250,450,450,450,450,450,450,450,1250,450,450,450,1250,450,450,450,450,450,1250,450,450,450,450,450,450,450,450,450,1250,450,1250,450,450,450,1250,450,450,450,450,450,450,450,1250,450,450,450,450,450,450,450,1250,450,450,450,1250,450,1250,450]}
```

### 送信
上記で取得したjsonをPOSTするとそれに応じてリモコン信号を送信する

``` sh:sendIrSignal.sh
curl -i "http://irweb_c1a1.local/messages" -H "X-Requested-With: curl" --data-binary @/irweb/data/sharp/ac-222fd/warm20_Louver2.json
```

### おまけ１
同梱の irweb2bin.py を使うと赤外線のON/OFFを1/0のバイナリに変換できる。
いくつかパターンを集めると、例えばエアコンの温度がどこに格納されているのかがわかるようになる。
``` sh:decodeIr.sh
$ cat /irweb/data/sharp/ac-222fd/warm20_Louver2.json | python /irweb/irweb2bin.py
AEHA	01010101010110101111001100001000110000001000100010000100000000000101000000000101000000000010011110000110
```

### おまけ２
同梱の bin2irweb.py を使うと1/0のバイナリを赤外線のON/OFFに変換できる。
任意の温度を設定した赤外線リモコン信号を送ることができるようになる。
``` sh:encodeIr.sh
$ echo "AEHA	01010101010110101111001100001000110000001000100010000100000000000101000000000101000000000010011110000110" | python /irweb/bin2irweb.py 
{"freq": 38, "data": [3400, 1700, 425, 425, 425, 1275, 425, 425, 425, 1275, 425, 425, 425, 1275, 425, 425, 425, 1275, 425, 425, 425, 1275, 425, 425, 425, 1275, 425, 1275, 425, 425, 425, 1275, 425, 425, 425, 1275, 425, 1275, 425, 1275, 425, 1275, 425, 425, 425, 425, 425, 1275, 425, 1275, 425, 425, 425, 425, 425, 425, 425, 425, 425, 1275, 425, 425, 425, 425, 425, 425, 425, 1275, 425, 1275, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 1275, 425, 425, 425, 425, 425, 425, 425, 1275, 425, 425, 425, 425, 425, 425, 425, 1275, 425, 425, 425, 425, 425, 425, 425, 425, 425, 1275, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 1275, 425, 425, 425, 1275, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 1275, 425, 425, 425, 1275, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 425, 1275, 425, 425, 425, 425, 425, 1275, 425, 1275, 425, 1275, 425, 1275, 425, 425, 425, 425, 425, 425, 425, 425, 425, 1275, 425, 1275, 425, 425, 425], "len": 211, "format": "raw"}
```

